<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Responsive AR.js with Leaflet Map</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      overflow: hidden;
      position: relative;
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
    }
    
    .a-canvas {
      width: 100% !important;
      height: 100% !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      z-index: 1 !important;
    }
    
    #map {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 30vw;
      max-width: 300px;
      height: 30vw;
      max-height: 300px;
      border: 2px solid white;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      z-index: 999;
      display: none; /* Initially hidden until AR scene is loaded */
    }
    
    #svgObject {
      width: 600px;
      height: 900px;
      border-left: 1px solid #ccc;
      display: none; /* Hidden in AR mode */
    }
    
    /* Special UI for desktop viewing mode */
    .desktop-mode .container {
      display: flex;
      flex-direction: row;
    }
    
    .desktop-mode #map {
      position: static;
      width: 460px;
      height: 900px;
      border: none;
      box-shadow: none;
      border-radius: 0;
      display: block;
    }
    
    .desktop-mode #svgObject {
      display: block;
    }
    
    .desktop-mode .a-canvas,
    .desktop-mode .a-scene {
      display: none !important;
    }
    
    /* Loading indicator */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    /* Toggle button for switching between AR and desktop view */
    #viewToggle {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 15px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 5px;
      z-index: 9999;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="loading">Loading AR Experience...</div>
  
  <button id="viewToggle">Switch to Desktop View</button>
  
  <div class="container">
    <div id="map"></div>
    <object id="svgObject" type="image/svg+xml" data="RDSC.svg"></object>
  </div>

  <!-- Leaflet -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  
  <!-- A-Frame and AR.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="svg.js"></script>
  <script src="leaflet.js"></script>

  <script>
    // Configuration options
    const config = {
      cameraParams: {
        mobile: {
          zoom: 1.0,
          fov: 60,
          near: 0.01,
          far: 1000
        },
        desktop: {
          zoom: 0.7,
          fov: 80,
          near: 0.1,
          far: 10000
        }
      },
      mapSizePercent: 30 // Size of map as percentage of viewport on mobile
    };
    
    // Helper function to detect mobile devices
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
             (window.innerWidth <= 800);
    }
    
    // Initialize map
    let map;
    function initMap() {
      map = L.map('map').setView([51.505, -0.09], 13);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Add your custom markers or overlays here
      L.marker([51.5, -0.09]).addTo(map)
        .bindPopup('A sample marker')
        .openPopup();
        
      return map;
    }
    
    // Initialize AR scene
    function initARScene() {
      return new Promise((resolve) => {
        // Create scene if it doesn't exist
        if (!document.querySelector('a-scene')) {
          const scene = document.createElement('a-scene');
          scene.setAttribute('embedded', '');
          scene.setAttribute('arjs', 'trackingMethod: best; sourceType: webcam; debugUIEnabled: false;');
          scene.setAttribute('vr-mode-ui', 'enabled: false');
          scene.setAttribute('renderer', 'logarithmicDepthBuffer: true; antialias: true;');
          
          // Add camera with parameters appropriate for device type
          const cameraParams = isMobileDevice() ? config.cameraParams.mobile : config.cameraParams.desktop;
          
          const camera = document.createElement('a-entity');
          camera.setAttribute('camera', `zoom: ${cameraParams.zoom}; fov: ${cameraParams.fov}; near: ${cameraParams.near}; far: ${cameraParams.far}`);
          camera.setAttribute('look-controls', 'enabled: false');
          camera.setAttribute('position', '0 0 0');
          camera.setAttribute('rotation', '0 0 0');
          
          scene.appendChild(camera);
          
          // Add lights
          const ambientLight = document.createElement('a-entity');
          ambientLight.setAttribute('light', 'type: ambient; color: #BBB; intensity: 0.5');
          scene.appendChild(ambientLight);
          
          const directionalLight = document.createElement('a-entity');
          directionalLight.setAttribute('light', 'type: directional; color: #FFF; intensity: 1.0');
          directionalLight.setAttribute('position', '-0.5 1 1');
          scene.appendChild(directionalLight);
          
          // Add a sample AR content (can be replaced with your actual content)
          const box = document.createElement('a-box');
          box.setAttribute('position', '0 0.5 -3');
          box.setAttribute('rotation', '0 45 0');
          box.setAttribute('color', '#4CC3D9');
          scene.appendChild(box);
          
          document.body.appendChild(scene);
          
          // Listen for scene loaded event
          scene.addEventListener('loaded', () => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            resolve(scene);
          });
        } else {
          resolve(document.querySelector('a-scene'));
        }
      });
    }
    
    // Handle view toggle
    function setupViewToggle() {
      const toggleBtn = document.getElementById('viewToggle');
      
      toggleBtn.addEventListener('click', () => {
        const isDesktopMode = document.body.classList.toggle('desktop-mode');
        toggleBtn.textContent = isDesktopMode ? 'Switch to AR View' : 'Switch to Desktop View';
        
        // Resize map when switching views
        if (map) {
          setTimeout(() => map.invalidateSize(), 100);
        }
      });
    }
    
    // Adjust map size based on viewport
    function adjustMapSize() {
      const mapElement = document.getElementById('map');
      
      if (!document.body.classList.contains('desktop-mode')) {
        // For mobile AR view
        const size = Math.min(window.innerWidth, window.innerHeight) * (config.mapSizePercent / 100);
        mapElement.style.width = `${size}px`;
        mapElement.style.height = `${size}px`;
      }
      
      // Force map to recalculate its size
      if (map) {
        map.invalidateSize();
      }
    }
    
    // Handle orientation changes
    function handleOrientationChange() {
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          adjustMapSize();
          if (map) map.invalidateSize();
        }, 200);
      });
      
      window.addEventListener('resize', () => {
        adjustMapSize();
        if (map) map.invalidateSize();
      });
    }
    
    // Initialize everything when the page loads
    window.addEventListener('load', async () => {
      // Set initial view mode based on device
      if (!isMobileDevice()) {
        document.body.classList.add('desktop-mode');
        document.getElementById('viewToggle').textContent = 'Switch to AR View';
      }
      
      // Initialize map
      const mapInstance = initMap();
      
      // Setup view toggle
      setupViewToggle();
      
      // Handle orientation changes
      handleOrientationChange();
      
      // Initialize AR scene for mobile or if desktop user wants to try AR
      if (isMobileDevice() || !document.body.classList.contains('desktop-mode')) {
        await initARScene();
      }
      
      // Adjust map size
      adjustMapSize();
    });
  </script>
</body>
</html>
